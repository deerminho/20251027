<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>랜덤이 만든 레전드플레이 | 민호특공대</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Pretendard", Arial, sans-serif;
            background: linear-gradient(135deg, #00CEC9 0%, #74B9FF 100%);
            min-height: 100vh;
            padding: 20px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
        }
        .container {
            background: white;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 206, 201, 0.3);
            overflow: hidden;
            max-width: 900px;
            margin: 0 auto;
        }
        .header {
            background: linear-gradient(135deg, #00CEC9 0%, #00B8B2 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .header::before {
            content: '⚡';
            position: absolute;
            font-size: 150px;
            opacity: 0.1;
            top: -30px;
            right: -20px;
        }
        .header h1 { font-size: 32px; margin-bottom: 8px; font-weight: 800; text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .header .album { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
        .header .subtitle { font-size: 16px; opacity: 0.95; font-weight: 500; margin-bottom: 5px; }
        .header .team-name { font-size: 14px; opacity: 0.9; }

        .video-wrapper { position: relative; padding-bottom: 56.25%; background: #000; height: 0; }
        #player { position: absolute; top:0; left:0; width:100%; height:100%; border:none; }

        .timer-section { padding: 25px 30px; background: linear-gradient(to bottom, white 0%, #f8fcfc 100%); text-align: center; border-bottom: 2px solid #e8f8f8; }
        .timer-display { font-size: 18px; color: #2d3436; font-weight: 600; margin-bottom: 8px; }
        .timer-number { font-size: 36px; color: #00CEC9; font-weight: 800; margin-bottom: 8px; }
        .now-playing { font-size: 14px; color: #636e72; margin-top: 5px; font-weight: 500; }

        .controls { padding: 30px; text-align: center; background: linear-gradient(to bottom, white 0%, #f8fcfc 100%); }
        .btn {
            background: linear-gradient(135deg, #00CEC9 0%, #00B8B2 100%);
            color: white; border: none; padding: 16px 45px;
            font-size: 17px; border-radius: 50px; cursor: pointer;
            font-weight: 700; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,206,201,0.3);
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 8px 25px rgba(0,206,201,0.4); }

        .playlist-section { padding: 35px 30px; background: #F0FFFE; border-top: 3px solid #00CEC9; }
        .playlist-section h3 { font-size: 20px; color: #2d3436; margin-bottom: 25px; text-align: center; font-weight: 700; }
        .playlist-section h3 .count { color: #00CEC9; font-weight: 800; font-size: 22px; }
        .video-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 20px; }
        .video-card {
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,206,201,0.15); transition: all 0.3s ease;
            cursor: pointer; border: 2px solid transparent;
        }
        .video-card:hover { transform: translateY(-8px); box-shadow: 0 12px 24px rgba(0,206,201,0.25); border-color: #00CEC9; }
        .video-card.playing { border-color: #FF6B6B; box-shadow: 0 0 0 4px rgba(255,107,107,0.2); }
        .video-thumbnail { position: relative; padding-bottom: 56.25%; background: #000; overflow: hidden; }
        .video-thumbnail img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit:cover; transition: transform 0.3s ease; }
        .video-card:hover .video-thumbnail img { transform: scale(1.05); }
        .video-info { padding: 14px; }
        .video-title { font-size: 14px; font-weight: 600; color: #2d3436; line-height: 1.5; min-height: 42px; }
        .footer { padding: 20px; text-align: center; background: white; color: #636e72; font-size: 13px; border-top: 1px solid #e9f5f5; }
        @media (max-width:600px){.video-grid{grid-template-columns:1fr;}.header h1{font-size:26px;}}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀랜덤플레이</h1>
            <div class="album">"(feat. 민트의 클릭)"</div>
            <div class="subtitle">⚡ 조회수는 우연이 아닙니다! ⚡</div>
            <div class="team-name"> 👀콘서트 전까지 달려 봅시다^^ </div>
        </div>

        <div class="video-wrapper">
            <div id="player"></div>
        </div>

        <div class="timer-section">
            <div class="timer-display">⏱️ 다음 곡까지</div>
            <div class="timer-number" id="timer">--</div>
            <div class="now-playing" id="nowPlaying">🔄 플레이어 로딩 중...</div>
        </div>

        <div class="controls">
            <button class="btn" onclick="playNextRandom()">🔄 다음 곡 재생</button>
        </div>

        <div class="playlist-section">
            <h3>📋 전곡 재생목록 <span class="count" id="videoCount">0</span>개</h3>
            <div class="video-grid" id="videoGrid"></div>
        </div>

        <div class="footer">
            Made with ❤️ by 민호특공대<br>
            <small style="opacity: 0.7;">🎁🎁🎁🎁🎁</small>
        </div>
    </div>

    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // 🔒 보안 강화
        document.addEventListener('contextmenu', e => { e.preventDefault(); return false; });
        document.addEventListener('selectstart', e => { e.preventDefault(); return false; });
        document.addEventListener('dragstart', e => { e.preventDefault(); return false; });
        document.addEventListener('copy', e => { e.preventDefault(); return false; });
        document.addEventListener('keydown', e => {
            if (e.key === 'F12' || e.keyCode === 123 ||
                (e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) ||
                (e.ctrlKey && e.key === 'U')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }, true);

        const videos = [
            { id: 'ZJo6KHpI-2k', title: '한계령 (Hankyeryeong Pass) Official MV' },
            { id: 'BRiBNS0aTVo', title: '내 곁에 있어주 | 야외녹음실 ｜LIVE' },
            { id: '-zYhlQn6yVI', title: '내 이름 아시죠 | 사랑의콜센타' },
            { id: '0JeQF_nrSmU', title: '내 곁에 있어주 (Stay by My Side) Official MV' },
            { id: 'jXJKJc5fZnE', title: '홀로된 사랑 (Lonely Love) Official MV' },
            { id: '6lq_G6l4xRs', title: 'Lonely Love(홀로된 사랑) | 1theK' }
        ];

        let player;
        let currentVideoIndex = -1;
        let countdown = 0;
        let timerInterval;
        let currentDuration = 0;
        let isPlayerReady = false;

        // ✅ YouTube API 초기화 (새로고침 대응)
        function onYouTubeIframeAPIReady() {
            initPlayer();
        }

        function initPlayer() {
            // 기존 플레이어가 있으면 제거
            if (player && player.destroy) {
                try {
                    player.destroy();
                } catch (e) {}
            }

            player = new YT.Player('player', {
                height: '360',
                width: '640',
                videoId: '',
                playerVars: { 
                    'autoplay': 1, 
                    'controls': 1, 
                    'rel': 0, 
                    'modestbranding': 1,
                    'playsinline': 1
                },
                events: { 
                    'onReady': onPlayerReady, 
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        // ✅ 페이지 로드 시 API 상태 확인
        window.addEventListener('load', function() {
            // YouTube API가 이미 로드되어 있는지 확인
            if (typeof YT !== 'undefined' && YT && YT.Player) {
                // API 준비 완료
                if (!player || !isPlayerReady) {
                    initPlayer();
                }
            }
            // API가 없으면 onYouTubeIframeAPIReady 콜백 대기
        });

        function onPlayerReady(event) {
            isPlayerReady = true;
            document.getElementById('nowPlaying').textContent = '✅ 플레이어 준비 완료!';
            initializePlaylist();
            setTimeout(() => playRandomVideo(), 300);
        }

        function onPlayerError(event) {
            console.error('플레이어 오류:', event.data);
            document.getElementById('nowPlaying').textContent = '⚠️ 영상 로드 오류 - 재시도 중...';
            setTimeout(() => playRandomVideo(), 3000);
        }

        function onPlayerStateChange(event) {
            // 영상이 재생 중일 때만 타이머 작동
            if (event.data === YT.PlayerState.PLAYING && countdown > 0) {
                // 자동 다음 곡 재생
            }
        }

        function getRandomDuration() {
            // ✅ 82~122초 (40초 범위) - 광고 포함 + 자연스러운 패턴
            return Math.floor(Math.random() * (122 - 82 + 1)) + 82;
        }

        function playRandomVideo() {
            let nextIndex;
            do {
                nextIndex = Math.floor(Math.random() * videos.length);
            } while (nextIndex === currentVideoIndex && videos.length > 1);
            playVideo(nextIndex);
        }

        function playVideo(index) {
            if (!isPlayerReady || !player || !player.loadVideoById) {
                console.log('플레이어 준비 중...');
                setTimeout(() => playVideo(index), 500);
                return;
            }

            currentVideoIndex = index;
            const video = videos[index];
            currentDuration = getRandomDuration();
            
            try {
                // ✅ endSeconds를 사용하여 정확한 시간에 영상 종료
                player.loadVideoById({
                    'videoId': video.id,
                    'startSeconds': 0,
                    'endSeconds': currentDuration
                });
                
                document.getElementById('nowPlaying').textContent = `🎵 ${video.title}`;
                highlightPlayingCard(index);
                startTimer(currentDuration);
            } catch (error) {
                console.error('영상 재생 오류:', error);
                setTimeout(() => playRandomVideo(), 2000);
            }
        }

        function startTimer(duration) {
            // ✅ 기존 타이머 완전히 정리
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            countdown = duration;
            updateTimerDisplay();

            timerInterval = setInterval(() => {
                countdown--;
                updateTimerDisplay();
                if (countdown <= 0) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    playRandomVideo();
                }
            }, 1000);
        }

        function updateTimerDisplay() {
            const minutes = Math.floor(countdown / 60);
            const seconds = countdown % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        function highlightPlayingCard(index) {
            document.querySelectorAll('.video-card').forEach(card => card.classList.remove('playing'));
            const card = document.getElementById(`card-${index}`);
            if (card) card.classList.add('playing');
        }

        function initializePlaylist() {
            const grid = document.getElementById('videoGrid');
            const count = document.getElementById('videoCount');
            grid.innerHTML = '';
            count.textContent = videos.length;

            videos.forEach((v, i) => {
                const card = document.createElement('div');
                card.className = 'video-card';
                card.id = `card-${i}`;
                card.innerHTML = `
                    <div class="video-thumbnail">
                        <img src="https://img.youtube.com/vi/${v.id}/mqdefault.jpg" alt="${v.title}">
                    </div>
                    <div class="video-info"><div class="video-title">${v.title}</div></div>
                `;
                card.onclick = () => { playVideo(i); window.scrollTo({top:0,behavior:'smooth'}); };
                grid.appendChild(card);
            });
        }

        function playNextRandom() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            playRandomVideo();
        }

        window.onbeforeunload = function() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        };

        // 🔒 개발자 도구 감지
        let devtoolsOpen = false;
        let reloadCount = parseInt(sessionStorage.getItem('reloadCount') || '0');
        
        // 무한 새로고침 방지
        if (reloadCount > 3) {
            console.log('과도한 새로고침 감지');
            sessionStorage.setItem('reloadCount', '0');
        }

        setInterval(() => {
            const threshold = 160;
            if (window.outerWidth - window.innerWidth > threshold || 
                window.outerHeight - window.innerHeight > threshold) {
                if (!devtoolsOpen && reloadCount < 3) {
                    devtoolsOpen = true;
                    reloadCount++;
                    sessionStorage.setItem('reloadCount', reloadCount.toString());
                    location.reload();
                }
            } else {
                devtoolsOpen = false;
                if (reloadCount > 0) {
                    setTimeout(() => {
                        sessionStorage.setItem('reloadCount', '0');
                    }, 5000);
                }
            }
        }, 500);
    </script>
</body>
</html>
